name: Build Flows in Shared (Push Tag)

on:
  push:
    tags:
      - '*.*.*-develop'
      - '*.*.*-staging'
      - '*.*.*'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      FLOWEDITOR_VERSION: ${{ steps.set-env.outputs.FLOWEDITOR_VERSION }}
      FLOWEDITOR_REPO: ${{ steps.set-env.outputs.FLOWEDITOR_REPO }}
      FLOWEDITOR_BRANCH: ${{ steps.set-env.outputs.FLOWEDITOR_BRANCH }}
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4
        if: github.event_name != 'pull_request'
        with:
          ref: "${{env.GITHUB_SHA}}"
          token: ${{ secrets.DEVOPS_GITHUB_PERMANENT_TOKEN }} 
      - name: Set up environment variables
        id: set-env
        run: |
            FLOWEDITOR_VERSION=$(jq -r '.dependencies["@nyaruka/flow-editor"]' < package.json)
            echo "IMAGE_SOURCE_URL=https://github.com/weni-ai/flows" | tee -a "${GITHUB_OUTPUT}"
            echo "FLOWEDITOR_VERSION=${FLOWEDITOR_VERSION}" | tee -a "${GITHUB_OUTPUT}"
            echo "FLOWEDITOR_REPO=https://github.com/ilhasoft/floweditor" | tee -a "${GITHUB_OUTPUT}"
            FLOWEDITOR_BRANCH=$(jq -r '.weni["floweditor-branch"]' < package.json)
            if [[ null == "${FLOWEDITOR_BRANCH}" ]]; then
              FLOWEDITOR_BRANCH="main"
            fi
            echo "FLOWEDITOR_BRANCH=$FLOWEDITOR_BRANCH" | tee -a "${GITHUB_OUTPUT}"
  call-workflow:
    uses: weni-ai/actions-workflows/.github/workflows/reusable-workflow.yaml@main
    needs:
      - setup
    with:
      image_repository: push-backend
      dockerfile: "docker/Dockerfile"
      build_args: 
        FLOWEDITOR_VERSION=${{ needs.setup.outputs.FLOWEDITOR_VERSION }}
        FLOWEDITOR_REPO=${{ needs.setup.outputs.FLOWEDITOR_REPO }}
        FLOWEDITOR_BRANCH=${{ needs.setup.outputs.FLOWEDITOR_BRANCH }}
      target_repository: weni-ai/kubernetes-manifests-platform
      target_repository_branch: main
      target_application: flows
      target_patch_file: deployment.json
    secrets: inherit