name: Build, push and deploy

on:
  push:
    tags:
      - '*.*.*-develop'
      - '*.*.*-staging'
      - '*.*.*'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      repository_name: ${{ steps.setup.outputs.repository_name }}
      build_args: ${{ steps.setup.outputs.build_args }}
    steps:
      - name: Setup outputs
        id: setup
        run: |
          {
            echo "repository_name=${GITHUB_REPOSITORY#$GITHUB_REPOSITORY_OWNER/}"

            echo 'BUILD_ARGS<<EOFenv'
            FLOWEDITOR_VERSION=$(
              jq -r '.dependencies["@nyaruka/flow-editor"]' < package.json
            )
            echo "FLOWEDITOR_VERSION=${FLOWEDITOR_VERSION}"
            echo "FLOWEDITOR_REPO=https://github.com/ilhasoft/floweditor"
            FLOWEDITOR_BRANCH=$(
              jq -r '.weni["floweditor-branch"]' < package.json
            )
            if [[ null == "${FLOWEDITOR_BRANCH}" ]]; then
              FLOWEDITOR_BRANCH="main"
            fi
            echo "FLOWEDITOR_BRANCH=${FLOWEDITOR_BRANCH}"
            echo 'EOFenv'
          } | tee -a "${GITHUB_OUTPUT}"

          {
            echo "### Workflow Outputs"
            echo "| Variable        | Value           |"
            echo "| --------------- | --------------- |"
            echo "| repository_name | Repository name |"
            echo "| build_args      | Build arguments for image |"
          } | tee -a "${GITHUB_STEP_SUMMARY}"

  call-workflow:
    uses: weni-ai/actions-workflows/.github/workflows/reusable-workflow.yaml@main
    needs:
      - setup
    with:
      deploy_type: 'kubernetes'
      dockerfile: 'docker/Dockerfile'
      target_application: "${{ needs.setup.outputs.repository_name }}"
      image_repository: 'push-backend'
      target_repository: 'weni-ai/kubernetes-manifests-platform'
      target_application_directory_prefix: 'weni-flows/'
      target_patch_file: 'deployment-flows-image.json'
      build_args: |
        ${{ needs.setup.outputs.build_args }}
    secrets: inherit

# vim: nu ts=2 fdm=indent et ft=yaml shiftwidth=2 softtabstop=2:
